
## my specs 
amd cpu
nvidia graphics card


# Preparations

IOMMU IS ENABLE IN THE BIOS!


SYSTEM IS IN UEFI MODE!
check with 

[ -d /sys/firmware/efi ] && echo "Installed in UEFI mode" || echo "Installed in Legacy mode"



## edit the boot options
normal you would look at the grub, but popos doesn't use grub
change the boot optoins with kernalstub


# change boot options

for amd:
sudo kernelstub -a amd_iommu=on iommu=pt video=efifb:off

for intel
sudo kernelstub -a intel_iommu=on iommu=pt video=efifb:off


check options at 
/etc/kernelstub/configuration

update with
sudo bootctl update

make sure to reboot for changes to take effect

should see changes in 
sudo cat /proc/cmdline

## check that iommu is valid

just to see if iommu is working
sudo dmesg | grep IOMMU


#script to check groups

https://gist.github.com/flungo/428c374c040de1d0a30fd4a593d39040


# install virtual machtine manger in the pop shop

this command will isntall virtual machine manger and libvert things
sudo apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virt-manager ovmf

once installed diso the libvirt conf 

open this file
sudo nano /etc/libvirt/libvirtd.conf

find and uncomment the following lines 

unix_sock_group = "libvirt"
unix_sock_rw_perms = "0770"

make sure this is at the end (helps with logs)
log_filters="1:qemu"
log_outputs="1:file:/var/log/libvirt/libvirtd.log"

### make sure to give permissions (not sure if you need this)

sudo usermod -a -G libvirt $(whoami)
sudo systemctl start libvirtd
sudo systemctl enable libvirtd

check with 
sudo groups $(whoami)
should show that you are in the group


### change the qemu conf (not sure if needed)

sudo nano /etc/libvirt/qemu.conf

#user = "root" to user = "your username"
#group = "root" to group = "your username"

restart libvert
sudo systemctl restart libvirtd

add to group
sudo usermod -a -G kvm,libvirt $(whoami)
sudo groups $(whoami)

enabling network
sudo virsh net-autostart default
sudo virsh net-start default


download virt io drivers
https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html

download windows iso 
https://www.microsoft.com/en-us/software-download/windows10ISO


now setup windows and add the vfio drivers

##you may or may not need to import a rom file


# vm hooks

look at these for a guide (test)
https://github.com/joeknock90/Single-GPU-Passthrough

check the log files 
sudo cat /var/log/libvirt/qemu/win10.log 


make sure to set up an ssh and vnc 

launch and test!
good luck
